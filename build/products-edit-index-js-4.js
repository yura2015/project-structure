(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{10:function(e,t,n){"use strict";function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,"a",(function(){return i}));class i{constructor({items:e=[]}={}){s(this,"onPointerMove",({clientX:e,clientY:t})=>{this.moveDraggingAt(e,t);const n=this.placeholderElement.previousElementSibling,s=this.placeholderElement.nextElementSibling,{firstElementChild:i,lastElementChild:r}=this.element,{top:a}=i.getBoundingClientRect(),{bottom:o}=this.element.getBoundingClientRect();if(t<a)return i.before(this.placeholderElement);if(t>o)return r.after(this.placeholderElement);if(n){const{top:e,height:s}=n.getBoundingClientRect();if(t<e+s/2)return n.before(this.placeholderElement)}if(s){const{top:e,height:n}=s.getBoundingClientRect();if(t>e+n/2&&s.nextElementSibling)return s.after(this.placeholderElement);if(!s.nextElementSibling)return s.before(this.placeholderElement)}this.scrollIfCloseToWindowEdge(t)}),s(this,"onPointerUp",()=>{this.dragStop()}),this.items=e,this.render()}render(){this.element=document.createElement("ul"),this.element.className="sortable-list",this.addItems(),this.initEventListeners()}addItems(){for(const e of this.items)e.classList.add("sortable-list__item");this.element.append(...this.items)}initEventListeners(){this.element.addEventListener("pointerdown",e=>{this.onPointerDown(e)})}onPointerDown(e){const t=e.target.closest(".sortable-list__item");t&&(e.target.closest("[data-grab-handle]")&&(e.preventDefault(),this.dragStart(t,e)),e.target.closest("[data-delete-handle]")&&(e.preventDefault(),t.remove()))}createPlaceholderElement(e,t){const n=document.createElement("li");return n.className="sortable-list__placeholder",n.style.width=e+"px",n.style.height=t+"px",n}dragStart(e,{clientX:t,clientY:n}){this.draggingElem=e,this.elementInitialIndex=[...this.element.children].indexOf(e);const{x:s,y:i}=e.getBoundingClientRect(),{offsetWidth:r,offsetHeight:a}=e;this.pointerShift={x:t-s,y:n-i},this.draggingElem.style.width=r+"px",this.draggingElem.style.height=a+"px",this.draggingElem.classList.add("sortable-list__item_dragging"),this.placeholderElement=this.createPlaceholderElement(r,a),this.draggingElem.after(this.placeholderElement),this.element.append(this.draggingElem),this.moveDraggingAt(t,n),this.addDocumentEventListeners()}addDocumentEventListeners(){document.addEventListener("pointermove",this.onPointerMove),document.addEventListener("pointerup",this.onPointerUp)}removeDocumentEventListeners(){document.removeEventListener("pointermove",this.onPointerMove),document.removeEventListener("pointerup",this.onPointerUp)}moveDraggingAt(e,t){this.draggingElem.style.left=e-this.pointerShift.x+"px",this.draggingElem.style.top=t-this.pointerShift.y+"px"}scrollIfCloseToWindowEdge(e){e<20?window.scrollBy(0,-10):e>document.documentElement.clientHeight-20&&window.scrollBy(0,10)}dragStop(){const e=[...this.element.children].indexOf(this.placeholderElement);this.draggingElem.style.cssText="",this.draggingElem.classList.remove("sortable-list__item_dragging"),this.placeholderElement.replaceWith(this.draggingElem),this.draggingElem=null,this.removeDocumentEventListeners(),e!==this.elementInitialIndex&&this.dispatchEvent("sortable-list-reorder",{from:this.elementInitialIndex,to:e})}dispatchEvent(e,t){this.element.dispatchEvent(new CustomEvent(e,{bubbles:!0,details:t}))}remove(){this.element&&this.element.remove()}destroy(){this.remove(),this.removeDocumentEventListeners(),this.element=null}}},13:function(e,t,n){"use strict";t.a=e=>e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},7:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return d}));var s=n(10),i=n(13),r=n(9);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const o="https://course-js.javascript.ru/";class l{constructor(e){a(this,"element",void 0),a(this,"subElements",{}),a(this,"defaultFormData",{title:"",description:"",quantity:1,subcategory:"",status:1,images:[],price:100,discount:0}),a(this,"uploadImage",()=>{const e=document.createElement("input");e.type="file",e.accept="image/*",e.onchange=async()=>{const[t]=e.files;if(t){const n=new FormData,{uploadImage:s,imageListContainer:i}=this.subElements;n.append("image",t),s.classList.add("is-loading"),s.disabled=!0;const a=await Object(r.a)("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID 28aaa2e823b03b1"},body:n});i.firstElementChild.append(this.getImageItem(a.data.link,t.name)),s.classList.remove("is-loading"),s.disabled=!1,e.remove()}},e.hidden=!0,document.body.appendChild(e),e.click()}),this.productId=e}template(){return`\n      <div class="product-form">\n      <form data-element="productForm" class="form-grid">\n        <div class="form-group form-group__half_left">\n          <fieldset>\n            <label class="form-label">Название товара</label>\n            <input required\n              id="title"\n              value=""\n              type="text"\n              name="title"\n              class="form-control"\n              data-element="title"\n              placeholder="Название товара"></input>\n          </fieldset>\n        </div>\n        <div class="form-group form-group__wide">\n          <label class="form-label">Описание</label>\n          <textarea required\n            id="description"\n            class="form-control"\n            name="description"\n            placeholder="Описание товара"></textarea>\n        </div>\n        <div class="form-group form-group__wide">\n          <label class="form-label">Фото</label>\n          <div data-element="imageListContainer"></div>\n          <button data-element="uploadImage" type="button" class="button-primary-outline">\n            <span>Загрузить</span>\n          </button>\n        </div>\n        <div class="form-group form-group__half_left">\n          <label class="form-label">Категория</label>\n            ${this.createCategoriesSelect()}\n        </div>\n        <div class="form-group form-group__half_left form-group__two-col">\n          <fieldset>\n            <label class="form-label">Цена ($)</label>\n            <input required\n              id="price"\n              value=""\n              type="number"\n              name="price"\n              class="form-control"\n              placeholder="${this.defaultFormData.price}"></input>\n          </fieldset>\n          <fieldset>\n            <label class="form-label">Скидка ($)</label>\n            <input required\n              id="discount"\n              value=""\n              type="number"\n              name="discount"\n              class="form-control"\n              placeholder="${this.defaultFormData.discount}"></input>\n          </fieldset>\n        </div>\n        <div class="form-group form-group__part-half">\n          <label class="form-label">Количество</label>\n          <input required\n            id="quantity"\n            value=""\n            type="number"\n            class="form-control"\n            name="quantity"\n            placeholder="${this.defaultFormData.quantity}"></input>\n        </div>\n        <div class="form-group form-group__part-half">\n          <label class="form-label">Статус</label>\n          <select id="status" class="form-control" name="status">\n            <option value="1">Активен</option>\n            <option value="0">Неактивен</option>\n          </select>\n        </div>\n        <div class="form-buttons">\n          <button type="submit" name="save" class="button-primary-outline">\n            ${this.productId?"Сохранить":"Добавить"} товар\n          </button>\n        </div>\n      </form>\n    </div>\n    `}async render(){const e=this.loadCategoriesList(),t=this.productId?this.loadProductData(this.productId):[this.defaultFormData],[n,s]=await Promise.all([e,t]),[i]=s;return this.formData=i,this.categories=n,this.renderForm(),this.formData&&(this.setFormData(),this.createImagesList(),this.initEventListeners()),this.element}renderForm(){const e=document.createElement("div");e.innerHTML=this.formData?this.template():this.getEmptyTemplate(),this.element=e.firstElementChild,this.subElements=this.getSubElements(this.element)}getEmptyTemplate(){return'<div>\n      <h1 class="page-title">Страница не найдена</h1>\n      <p>Извините, данный товар не существует</p>\n    </div>'}async save(){const e=this.getFormData(),t=await Object(r.a)(o+"api/rest/products",{method:this.productId?"PATCH":"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});this.dispatchEvent(t.id)}getFormData(){const{imageListContainer:e,productForm:t}=this.subElements,n=["images"],s=["price","quantity","discount","status"],i=Object.keys(this.defaultFormData).filter(e=>!n.includes(e)),r=e=>t.querySelector(`[name=${e}]`),a={};for(const e of i){const t=r(e);a[e]=s.includes(e)?parseInt(t,10):t}const o=e.querySelectorAll(".sortable-table__cell-img");a.images=[],a.id=this.productId;for(const e of o)a.images.push({url:e.src,source:e.alt});return a}dispatchEvent(e){const t=this.productId?new CustomEvent("product-updated",{detail:e}):new CustomEvent("product-saved");this.element.dispatchEvent(t)}setFormData(){const{productForm:e}=this.subElements,t=["images"];Object.keys(this.defaultFormData).filter(e=>!t.includes(e)).forEach(t=>{e.querySelector("#"+t).value=this.formData[t]||this.defaultFormData[t]})}loadProductData(e){return Object(r.a)(`${o}api/rest/products?id=${e}`)}loadCategoriesList(){return Object(r.a)(o+"api/rest/categories?_sort=weight&_refs=subcategory")}createCategoriesSelect(){const e=document.createElement("div");e.innerHTML='<select class="form-control" id="subcategory" name="subcategory"></select>';const t=e.firstElementChild;for(const e of this.categories)for(const n of e.subcategories)t.append(new Option(`${e.title} > ${n.title}`,n.id));return t.outerHTML}getSubElements(e){const t={},n=e.querySelectorAll("[data-element]");for(const e of n)t[e.dataset.element]=e;return t}createImagesList(){const{imageListContainer:e}=this.subElements,{images:t}=this.formData,n=t.map(({url:e,source:t})=>this.getImageItem(e,t)),i=new s.a({items:n});e.append(i.element)}getImageItem(e,t){const n=document.createElement("div");return n.innerHTML=`\n      <li class="products-edit__imagelist-item sortable-list__item">\n        <span>\n          <img src="../icons/icon-grab.svg" data-grab-handle alt="grab">\n          <img class="sortable-table__cell-img" alt="${Object(i.a)(t)}" src="${Object(i.a)(e)}">\n          <span>${Object(i.a)(t)}</span>\n        </span>\n        <button type="button">\n          <img src="../icons/icon-trash.svg" alt="delete" data-delete-handle>\n        </button>\n      </li>`,n.firstElementChild}initEventListeners(){const{productForm:e,uploadImage:t}=this.subElements;e.addEventListener("submit",this.onSubmit),t.addEventListener("click",this.uploadImage)}destroy(){this.remove(),this.element=null,this.subElements=null}remove(){this.element.remove()}}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class d{constructor(e){c(this,"element",void 0),c(this,"subElements",{}),c(this,"components",{}),this.productId=e}initComponents(){const e=new l(this.productId);this.components={productForm:e}}async randerComponents(){const e=this.element.querySelector("[data-element]"),t=await this.components.productForm.render();e.append(t)}get template(){return' \n             <div class="products-edit">\n              <div class="content__top-panel">\n                <h1 class="page-title">\n                  <a href="/products" class="link">Товары</a> / Редактировать\n                </h1>\n              </div>\n              <div  data-element="productForm"></div>\n            </div>'}render(){return this.element=document.createElement("div"),this.element.innerHTML=this.template,this.element=this.element.firstElementChild,this.subElements=this.getSubElements(this.element),this.initComponents(),this.randerComponents(),this.element}getSubElements(e){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}remove(){this.element&&this.element.remove()}destroy(){this.remove();for(let e in this.components)this.components[e].destroy();this.element=null,this.subElements={}}}},9:function(e,t,n){"use strict";t.a=async function(e,t){let n,i;try{n=await fetch(e.toString(),t)}catch(e){throw new s(n,"Network error has occurred.")}if(!n.ok){let e=n.statusText;try{i=await n.json(),e=i.error&&i.error.message||i.data&&i.data.error&&i.data.error.message||e}catch(e){}let t=`Error ${n.status}: ${e}`;throw new s(n,i,t)}try{return await n.json()}catch(e){throw new s(n,null,e.message)}};class s extends Error{constructor(e,t,n){var s,i,r;super(n),r="FetchError",(i="name")in(s=this)?Object.defineProperty(s,i,{value:r,enumerable:!0,configurable:!0,writable:!0}):s[i]=r,this.response=e,this.body=t}}window.addEventListener("unhandledrejection",e=>{e.reason instanceof s&&alert(e.reason.message)})}}]);
//# sourceMappingURL=products-edit-index-js-4.js.map